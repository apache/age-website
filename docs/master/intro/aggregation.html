

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Aggregation &mdash; Apache AGE master documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MATCH" href="../clauses/match.html" />
    <link rel="prev" title="Operator Precedence" href="precedence.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Apache AGE
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="graphs.html">Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="cypher.html">The AGE Cypher Query Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html">Data Types - An Introduction to agtype</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparability.html">Comparability, Equality, Orderability and Equivalence</a></li>
<li class="toctree-l1"><a class="reference internal" href="precedence.html">Operator Precedence</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Aggregation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-setup">Data Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auto-group-by">Auto Group By</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sorting-on-aggregate-functions">Sorting on aggregate functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#distinct-aggregation">Distinct aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ambiguous-grouping-statements">Ambiguous Grouping Statements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#invalid-query-in-age">Invalid Query in AGE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#valid-query-in-age">Valid Query in AGE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vertices-and-edges-in-ambiguous-grouping">Vertices and edges in ambiguous grouping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hiding-unwanted-grouping-keys">Hiding unwanted grouping keys</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Clauses</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../clauses/match.html">MATCH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/with.html">WITH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/return.html">RETURN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/order_by.html">ORDER BY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/skip.html">SKIP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/limit.html">LIMIT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/create.html">CREATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/set.html">SET</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/remove.html">REMOVE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clauses/delete.html">DELETE</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Functions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../functions/predicate_functions.html">Predicate Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/scalar_functions.html">Scalar Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/list_functions.html">List Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/numeric_functions.html">Numeric Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/logarithmic_functions.html">Logarithmic Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/trigonometric_functions.html">Trigonometric Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/string_functions.html">String Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/aggregate_functions.html">Aggregation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions/user_functions.html">User defined functions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AGE Beyond Cypher</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced_overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced.html">Using Cypher in a CTE Expression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced.html#using-cypher-in-a-join-expression">Using Cypher in a Join expression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/advanced.html#cypher-in-sql-expressions">Cypher in SQL expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/prepared_statements.html">Prepared Statements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/plpgsql.html">PL/pgSQL Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/sql_in_cypher.html">SQL In Cypher</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apache AGE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Aggregation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/apache/incubator-age-website/blob/master/docs/intro/aggregation.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="tex2jax_ignore mathjax_ignore section" id="aggregation">
<h1>Aggregation<a class="headerlink" href="#aggregation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Generally an aggregation aggr(expr) processes all matching rows for each aggregation key found in an incoming record (keys are compared using <span class="xref myst">equivalence</span>).</p>
<p>In a regular aggregation (i.e. of the form aggr(expr)), the list of aggregated values is the list of candidate values with all null values removed from it.</p>
</div>
<div class="section" id="data-setup">
<h2>Data Setup<a class="headerlink" href="#data-setup" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
	CREATE (a:Person {name: &#39;A&#39;, age: 13}),
	(b:Person {name: &#39;B&#39;, age: 33, eyes: &quot;blue&quot;}),
	(c:Person {name: &#39;C&#39;, age: 44, eyes: &quot;blue&quot;}),
	(d1:Person {name: &#39;D&#39;, eyes: &quot;brown&quot;}),
	(d2:Person {name: &#39;D&#39;}),
	(a)-[:KNOWS]-&gt;(b),
	(a)-[:KNOWS]-&gt;(c),
	(a)-[:KNOWS]-&gt;(d1),
	(b)-[:KNOWS]-&gt;(d2),
	(c)-[:KNOWS]-&gt;(d2)
$$) as (a agtype);
</pre></div>
</div>
</div>
<div class="section" id="auto-group-by">
<h2>Auto Group By<a class="headerlink" href="#auto-group-by" title="Permalink to this headline">¶</a></h2>
<p>To calculate aggregated data, Cypher offers aggregation, analogous to SQL’s GROUP BY.</p>
<p>Aggregating functions take a  set of values and calculate An aggregated value over them. Examples are <a class="reference external" href="../functions/aggregate_functions.html#avg">avg()</a> that calculates the average of multiple numeric values, or <a class="reference external" href="../functions/aggregate_functions.html#min">min()</a> that finds the smallest numeric or string value in a set of values. When we say below that an aggregating function operates on a set of values, we mean these to be the result of the application of the inner expression(such as n.age) to all the records within the same aggregation group.</p>
<p>Aggregation can be computed over all the matching subgraphs, or it can be further divided by introducing grouping keys. These are non-aggregate expressions, that are used to group the valuesgoing into the aggregate functions.</p>
<p>Assume we have the following return statement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
	MATCH (v:Person)
	RETURN v.name, count(*)
$$) as (grouping_key agtype, count agtype);
</pre></div>
</div>
<table>
  <tr>
   <td>count</td>
   <td>key</td>
  </tr>
  <tr>
   <td>"A"</td>
   <td>1</td>
  </tr>
  <tr>
   <td>"B"</td>
   <td>1</td>
  </tr>
  <tr>
   <td>"C"</td>
   <td>1</td>
  </tr>
  <tr>
   <td>"D"</td>
   <td>2</td>
  </tr>
  <tr>
   <td colspan="2">1 row</td>
  </tr>
</table>
<p>We have two return expressions: grouping_key, and count(<em>). The first, grouping_key, is not an aggregate function, and so it will  be  the  grouping  key. The latter, count(</em>) is an aggregate expression. The matching subgraphs will be divided into different  buckets, depending on the grouping key. The aggregate function will then be run on these buckets, calculating an aggregate value per bucket.</p>
</div>
<div class="section" id="sorting-on-aggregate-functions">
<h2>Sorting on aggregate functions<a class="headerlink" href="#sorting-on-aggregate-functions" title="Permalink to this headline">¶</a></h2>
<p>To use aggregations to sort the result set, the aggregation must be included in the RETURN to be used in the ORDER BY.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT *
FROM cypher(&#39;graph_name&#39;, $$
	MATCH (me:Person)-[]-&gt;(friend:Person)
	RETURN count(friend), me
	ORDER BY count(friend)
$$) as (friends agtype, me agtype);
</pre></div>
</div>
</div>
<div class="section" id="distinct-aggregation">
<h2>Distinct aggregation<a class="headerlink" href="#distinct-aggregation" title="Permalink to this headline">¶</a></h2>
<p>In a distinct aggregation (i.e. of the form aggr(DISTINCT expr)), the list of aggregated values is the list of candidate values with all null values  removed from it. Furthermore, in a distinct aggregation, only one of all equivalent candidate values is included in the list of aggregated values, i.e. duplicates under equivalence are  removed.</p>
<p>The DISTINCT operator works in conjunction with aggregation. It is used to make all values unique before running them  through an aggregate function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT *
FROM cypher(&#39;graph_name&#39;, $$
	MATCH (v:Person)
	RETURN count(DISTINCT v.eyes), count(v.eyes)
$$) as (distinct_eyes agtype, eyes agtype);
</pre></div>
</div>
<table>
  <tr>
   <td>distinct_eyes</td>
   <td>eyes</td>
  </tr>
  <tr>
   <td>2</td>
   <td>3</td>
  </tr>
  <tr>
   <td colspan="2">1 row</td>
  </tr>
</table>
</div>
<div class="section" id="ambiguous-grouping-statements">
<h2>Ambiguous Grouping Statements<a class="headerlink" href="#ambiguous-grouping-statements" title="Permalink to this headline">¶</a></h2>
<p>This feature of not requiring the user to specifiy their grouping keys for a query allows for ambiguity on what Cypher should qualify as their grouping keys. For more details <a class="reference external" href="https://opencypher.org/articles/2017/07/27/ocig1-aggregations-article/">click here.</a></p>
<p>Data Setup</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
CREATE (:L {a: 1, b: 2, c: 3}),
       (:L {a: 2, b: 3, c: 1}),
       (:L {a: 3, b: 1, c: 2})
$$) as (a agtype);
</pre></div>
</div>
<div class="section" id="invalid-query-in-age">
<h3>Invalid Query in AGE<a class="headerlink" href="#invalid-query-in-age" title="Permalink to this headline">¶</a></h3>
<p>AGE’s solution to this problem is to not allow a WITH or RETURN column to combine aggregate functions with variables that are not explicitly listed in another column of the same WITH or RETURN clause.</p>
<p>Query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
	MATCH (x:L)
	RETURN x.a + count(*) + x.b + count(*) + x.c
$$) as (a agtype);
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ERROR</span><span class="p">:</span>  <span class="s2">&quot;x&quot;</span> <span class="n">must</span> <span class="n">be</span> <span class="n">either</span> <span class="n">part</span> <span class="n">of</span> <span class="n">an</span> <span class="n">explicitly</span> <span class="n">listed</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">used</span> <span class="n">inside</span> <span class="n">an</span> <span class="n">aggregate</span> <span class="n">function</span>
<span class="n">LINE</span> <span class="mi">3</span><span class="p">:</span> <span class="n">RETURN</span> <span class="n">x</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
</div>
<div class="section" id="valid-query-in-age">
<h3>Valid Query in AGE<a class="headerlink" href="#valid-query-in-age" title="Permalink to this headline">¶</a></h3>
<p>Columns that do not include an aggregate function in AGE are considered to be the grouping keys for that WITH or RETURN clause.</p>
<p>For the above query, the user could rewrite the query is several ways that will return results</p>
<p>Query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
	MATCH (x:L)
	RETURN (x.a + x.b + x.c) + count(*) + count(*), x.a + x.b + x.c
$$) as (count agtype, key agtype);
</pre></div>
</div>
<p>x.a + x.b + x.c is the grouping key. Grouping keys created like this must include parenthesis.</p>
<p>Results</p>
<table>
  <tr>
   <td>count</td>
   <td>key</td>
  </tr>
  <tr>
   <td>12</td>
   <td>6</td>
  </tr>
  <tr>
   <td colspan="2">1 row</td>
  </tr>
</table>
<p>Query</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
	MATCH (x:L)
	RETURN x.a + count(*) + x.b + count(*) + x.c, x.a, x.b, x.c
$$) as (count agtype, a agtype, b agtype, c agtype);
</pre></div>
</div>
<p>x.a, x.b, and x.c will be considered different grouping keys</p>
<p>Results:</p>
<table>
  <thead>
  <tr>
   <td>count</td>
   </td>a<td>
   </td>b<td>
   </td>c<td>
  </tr>
  </thead>
  <tr>
   <td>8</td>
   <td>3</td>
   <td>1</td>
   <td>2</td>
  </tr>
  <tr>
   <td>8</td>
   <td>2</td>
   <td>3</td>
   <td>1</td>
  </tr>
  <tr>
   <td>8</td>
   <td>1</td>
   <td>2</td>
   <td>3</td>
  </tr>
  <tr>
   <td colspan="4">3 rows</td>
  </tr>
</table>
</div>
<div class="section" id="vertices-and-edges-in-ambiguous-grouping">
<h3>Vertices and edges in ambiguous grouping<a class="headerlink" href="#vertices-and-edges-in-ambiguous-grouping" title="Permalink to this headline">¶</a></h3>
<p>Alternatively, the grouping key can be a vertex or edge, and then any properties of the vertex or edge can be specified without being explicitly stated in a WITH or RETURN column.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SELECT * FROM cypher(&#39;graph_name&#39;, $$
	MATCH (x:L)
	RETURN count(*) + count(*) + x.a + x.b + x.c, x
$$) as (count agtype, key agtype);
</pre></div>
</div>
<p>Results will be grouped on x, because it is safe to assume that properties be considered unecessary for grouping to be unambiguous.</p>
<p>Results</p>
<table>
  <thead>
  <tr>
   <td>count</td>
   </td>key<td>
  </tr>
  </thead>
  <tr>
   <td>8</td>
   <td>{"id": 1407374883553283, "label": "L", "properties": {"a": 3, "b": 1, "c": 2}}::vertex</td>
  </tr>
  <tr>
   <td>8</td>
   <td>{"id": 1407374883553281, "label": "L", "properties": {"a": 1, "b": 2, "c": 3}}::vertex</td>
  </tr>
  <tr>
   <td>8</td>
   <td>{"id": 1407374883553282, "label": "L", "properties": {"a": 2, "b": 3, "c": 1}}::vertex</td>
  </tr>
  <tr>
   <td colspan="4">3 rows</td>
  </tr>
</table>
</div>
<div class="section" id="hiding-unwanted-grouping-keys">
<h3>Hiding unwanted grouping keys<a class="headerlink" href="#hiding-unwanted-grouping-keys" title="Permalink to this headline">¶</a></h3>
<p>If the grouping key is considered unecessary for the query output, the aggregation can be done in a WITH clause then passing information to the RETURN clause.</p>
<p>SELECT * FROM cypher(‘graph_name’, $<span class="math notranslate nohighlight">\(
	MATCH (x:L)
	WITH count(*) + count(*) + x.a + x.b + x.c as column, x
	RETURN column
\)</span>$) as (a agtype);</p>
<p>Results</p>
<table>
  <thead>
  <tr>
   <td>a</td>
  </tr>
  </thead>
  <tr>
   <td>8</td>
  </tr>
  <tr>
   <td>8</td>
  </tr>
  <tr>
   <td>8</td>
  </tr>
  <tr>
   <td colspan="1">3 rows</td>
  </tr>
</table>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../clauses/match.html" class="btn btn-neutral float-right" title="MATCH" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="precedence.html" class="btn btn-neutral float-left" title="Operator Precedence" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Apache AGE.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      <dd><a href="aggregation.html">master</a></dd>
    </dl>
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>